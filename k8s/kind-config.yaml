# Kind cluster configuration for local testing
# This creates a multi-node cluster that mimics production
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
name: wcd-platform

# Networking configuration
networking:
  ipFamily: ipv4
  apiServerPort: 6443
  podSubnet: "10.244.0.0/16"
  serviceSubnet: "10.96.0.0/12"
  disableDefaultCNI: false
  kubeProxyMode: "ipvs"

# Cluster nodes configuration
nodes:
  # Control plane node
  - role: control-plane
    image: kindest/node:v1.29.0
    kubeadmConfigPatches:
    - |
      kind: InitConfiguration
      nodeRegistration:
        kubeletExtraArgs:
          node-labels: "node-type=control-plane"
    extraPortMappings:
    # Expose API server
    - containerPort: 6443
      hostPort: 6443
      protocol: TCP
    # Expose Ingress HTTP
    - containerPort: 80
      hostPort: 80
      protocol: TCP
    # Expose Ingress HTTPS
    - containerPort: 443
      hostPort: 443
      protocol: TCP
    # Expose NodePort range (for testing)
    - containerPort: 30000
      hostPort: 30000
      protocol: TCP
    - containerPort: 30001
      hostPort: 30001
      protocol: TCP
    - containerPort: 30002
      hostPort: 30002
      protocol: TCP
    extraMounts:
    - hostPath: ./data
      containerPath: /data
      readOnly: false
      selinuxRelabel: false
      propagation: None

  # Worker node 1
  - role: worker
    image: kindest/node:v1.29.0
    kubeadmConfigPatches:
    - |
      kind: JoinConfiguration
      nodeRegistration:
        kubeletExtraArgs:
          node-labels: "node-type=worker,zone=zone-a"
    extraMounts:
    - hostPath: ./data
      containerPath: /data
      readOnly: false

  # Worker node 2
  - role: worker
    image: kindest/node:v1.29.0
    kubeadmConfigPatches:
    - |
      kind: JoinConfiguration
      nodeRegistration:
        kubeletExtraArgs:
          node-labels: "node-type=worker,zone=zone-b"
    extraMounts:
    - hostPath: ./data
      containerPath: /data
      readOnly: false

  # Worker node 3 (optional - comment out for smaller clusters)
  - role: worker
    image: kindest/node:v1.29.0
    kubeadmConfigPatches:
    - |
      kind: JoinConfiguration
      nodeRegistration:
        kubeletExtraArgs:
          node-labels: "node-type=worker,zone=zone-c"
    extraMounts:
    - hostPath: ./data
      containerPath: /data
      readOnly: false

# Feature gates and runtime configuration
featureGates:
  EphemeralContainers: true
  HPAScaleToZero: true

# Container runtime configuration
containerdConfigPatches:
- |-
  [plugins."io.containerd.grpc.v1.cri".registry.mirrors."localhost:5000"]
    endpoint = ["http://kind-registry:5000"]